<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Newborn HR/RR Practice</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: #f7f7fb; color: #111827; margin: 0; }
    .container { max-width: 900px; margin: 0 auto; padding: 24px; }

    header { display: flex; justify-content: space-between; flex-wrap: wrap; align-items: center; margin-bottom: 18px; gap: 10px; }
    h1 { font-size: 1.4rem; margin: 0; }
    .header-btns { display: flex; gap: 10px; align-items: center; }

    button { border: 0; padding: 10px 14px; border-radius: 12px; cursor: pointer; }
    button.primary { background: #2563eb; color: #fff; }
    button.primary:hover { background: #1d4ed8; }

    /* Round icon button for play/pause */
    .icon-btn {
      background: #e5e7eb; color: #111; display: inline-flex; align-items: center; justify-content: center;
      width: 44px; height: 44px; border-radius: 999px; padding: 0;
    }
    .icon-btn:hover { background: #d1d5db; }
    .icon { width: 22px; height: 22px; display: block; }

    .status { margin: 10px 0; padding: 8px 10px; border-radius: 8px; font-size: 0.9rem; display: none; background: #fffbeb; border: 1px solid #fef3c7; color: #92400e; }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 14px; }
    .card {
      background: #fff; padding: 16px; border-radius: 12px; border: 1px solid #e5e7eb;
      display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
    }
    .card .input-line { display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap; }
    .card label { width: 100%; text-align: center; margin-bottom: 8px; }

    input { width: 140px; padding: 10px 12px; border-radius: 10px; border: 1px solid #d1d5db; font-size: 1rem; }

    .badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 999px; margin-left: 6px; }
    .ok { background: #d1fae5; color: #065f46; }
    .no { background: #fee2e2; color: #991b1b; }

    audio { display: none; }
    #confetti { position:fixed; inset:0; pointer-events:none; z-index:9999; }

    /* --- Mobile tweaks --- */
    @media (max-width: 640px) {
      header { justify-content: center; }
      header h1 { width: 100%; text-align: center; }
      .header-btns { width: 100%; justify-content: center; }

      .bottom-actions { text-align: center; }
      .bottom-actions > * { display: inline-block; margin: 4px 6px; }

      /* Force badges onto their own line under the "Actual:" text */
      #hr-actual .badge, #rr-actual .badge { display: block; margin-left: 0; margin-top: 4px; }

      /* Slightly larger inputs for thumbs */
      input { width: 160px; }
    }
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>

  <div class="container">
    <header>
      <h1>Newborn HR/RR Practice</h1>
      <div class="header-btns">
        <button id="new-sound" class="primary">New sound</button>
        <!-- SVG Play/Pause -->
        <button id="play-pause" class="icon-btn" aria-label="Play" title="Play" data-state="paused"></button>
      </div>
    </header>

    <div id="status" class="status"></div>
    <audio id="audio" preload="auto"></audio>

    <div class="grid">
      <div class="card" id="card-hr">
        <label for="hr">Heart rate (beats/min)</label>
        <div class="input-line">
          <input id="hr" inputmode="numeric" pattern="[0-9]*">
          <div id="hr-actual"></div>
        </div>
      </div>
      <div class="card" id="card-rr">
        <label for="rr">Respiratory rate (breaths/min)</label>
        <div class="input-line">
          <input id="rr" inputmode="numeric" pattern="[0-9]*">
          <div id="rr-actual"></div>
        </div>
      </div>
    </div>

    <div class="bottom-actions" style="margin-top:16px;">
      <button id="check" class="primary">Check</button>
      <button id="clear" class="icon-btn" aria-label="Clear" title="Clear" style="width:auto; height:auto; border-radius:12px; padding:10px 14px;">Clear</button>
    </div>
  </div>

<script>
/* ------ SVG icons (consistent on Android/iOS/Desktop) ------ */
const ICONS = {
  play:  '<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z" fill="currentColor"/></svg>',
  pause: '<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 5h4v14H6zM14 5h4v14h-4z" fill="currentColor"/></svg>'
};

/* ------ App logic ------ */
const FILES = [
  "Breath(38)Heart(126).mp3","Breath(40)Heart(120).mp3","Breath(42)Heart(144).mp3",
  "Breath(46)Heart(130).mp3","Breath(48)Heart(138).mp3","Breath(50)Heart(144).mp3",
  "Breath(52)Heart(146).mp3","Breath(52)Heart(150).mp3",
];

const audioEl = document.getElementById('audio');
const statusBox = document.getElementById('status');
const playBtn = document.getElementById('play-pause');
let currentFile = null;
let truth = {hr:null, rr:null};

function parseRates(filename){
  const m = filename.match(/Breath\((\d+)\)Heart\((\d+)\)\.mp3$/i);
  return m ? { rr: +m[1], hr: +m[2] } : { rr:null, hr:null };
}
function setStatus(msg){ statusBox.style.display = msg ? 'block' : 'none'; statusBox.textContent = msg||''; }
async function loadAndPlay(file){
  currentFile = file; truth = parseRates(file);
  hr.value=''; rr.value=''; hrA.textContent=''; rrA.textContent='';
  audioEl.loop = true; audioEl.src = file;
  try { await audioEl.play(); setStatus(''); setPlayState(true); } catch { setStatus('Audio ready. Press Play.'); setPlayState(false); }
}

/* Inputs & UI refs */
const hr = document.getElementById('hr');
const rr = document.getElementById('rr');
const hrA = document.getElementById('hr-actual');
const rrA = document.getElementById('rr-actual');

/* Initialize play button icon */
setPlayState(false);

document.getElementById('new-sound').onclick = () => loadAndPlay(FILES[Math.floor(Math.random()*FILES.length)]);

playBtn.onclick = async () => {
  if (!audioEl.src) {
    // If no file loaded yet, act like "New sound"
    await loadAndPlay(FILES[Math.floor(Math.random()*FILES.length)]);
    return;
    }
  if (audioEl.paused) {
    try { await audioEl.play(); setStatus(''); setPlayState(true); } catch { setStatus('Press Play again if needed.'); }
  } else {
    audioEl.pause(); setPlayState(false);
  }
};

document.getElementById('clear').onclick = () => { hr.value=''; rr.value=''; hrA.textContent=''; rrA.textContent=''; };

document.getElementById('check').onclick = () => {
  if (!currentFile) { setStatus('Click “New sound” first.'); return; }
  const hrVal = parseInt(hr.value.trim(),10), rrVal = parseInt(rr.value.trim(),10);
  const hrOK = Number.isFinite(hrVal) && Math.abs(hrVal - truth.hr) <= 10;
  const rrOK = Number.isFinite(rrVal) && Math.abs(rrVal - truth.rr) <= 5;
  const hrExact = Number.isFinite(hrVal) && hrVal === truth.hr;
  const rrExact = Number.isFinite(rrVal) && rrVal === truth.rr;

  hrA.innerHTML =
    `<span>Actual: <strong>${truth.hr}</strong></span> ` +
    (hrExact ? '<span class="badge ok">Perfect</span>' :
     hrOK ? '<span class="badge ok">Correct (±10)</span>' :
            '<span class="badge no">Check count</span>');

  rrA.innerHTML =
    `<span>Actual: <strong>${truth.rr}</strong></span> ` +
    (rrExact ? '<span class="badge ok">Perfect</span>' :
     rrOK ? '<span class="badge ok">Correct (±5)</span>' :
            '<span class="badge no">Check count</span>');

  // Mobile vs desktop confetti origin
  const stacked = cardsStacked();
  if (hrExact) confettiFromElement(hr, {fromTop: !stacked});
  if (rrExact) confettiFromElement(rr, {fromTop: !stacked, sibling: hrExact ? hr : null});
};

/* ------ Play/Pause state visuals ------ */
function setPlayState(isPlaying) {
  if (isPlaying) {
    playBtn.dataset.state = 'playing';
    playBtn.setAttribute('aria-label', 'Pause');
    playBtn.setAttribute('title', 'Pause');
    playBtn.innerHTML = ICONS.pause;
  } else {
    playBtn.dataset.state = 'paused';
    playBtn.setAttribute('aria-label', 'Play');
    playBtn.setAttribute('title', 'Play');
    playBtn.innerHTML = ICONS.play;
  }
}

/* ------ Layout helper: are the cards stacked? ------ */
function cardsStacked() {
  const hrRect = document.getElementById('card-hr').getBoundingClientRect();
  const rrRect = document.getElementById('card-rr').getBoundingClientRect();
  return rrRect.top >= hrRect.bottom - 1 || hrRect.top >= rrRect.bottom - 1;
}

/* ------ Confetti engine (supports simultaneous bursts) ------ */
const canvas = document.getElementById('confetti');
const ctx = canvas.getContext('2d', { alpha: true });
let W=0, H=0;
function resize(){ W = canvas.width = innerWidth; H = canvas.height = innerHeight; }
resize(); addEventListener('resize', resize);

let particles = [];
let rafId = null;
let lastT = 0;

/**
 * Fire confetti aligned to an element.
 * Options:
 * - fromTop: if true, spawn at top (y=0) aligned horizontally; if false, spawn at element's bottom edge.
 * - sibling: optional second element; if both share (nearly) same x-center, offset a bit so bursts are distinct on mobile.
 */
function confettiFromElement(el, {fromTop=true, sibling=null} = {}) {
  const rect = el.getBoundingClientRect();
  let x = rect.left + rect.width/2;
  let y = fromTop ? 0 : (rect.top + rect.height);

  if (sibling) {
    const sRect = sibling.getBoundingClientRect();
    const sx = sRect.left + sRect.width/2;
    if (Math.abs(sx - x) < 24) x += 32; // small horizontal offset so two bursts don't overlap
  }

  const colors = ['#ef4444','#f59e0b','#10b981','#3b82f6','#a855f7','#ec4899','#22d3ee','#84cc16'];
  const N = 140;
  const life = 1800 + Math.random()*600;
  const now = performance.now();

  for (let i=0;i<N;i++){
    const angle = Math.PI/2 + (Math.random()-0.5)*2.2;  // downward, wide spread
    const speed = (0.55 + Math.random()*0.9) * (H/1.6);
    particles.push({
      x, y,
      vx: Math.cos(angle)*speed,
      vy: Math.sin(angle)*speed,
      size: 3 + Math.random()*5,
      rot: Math.random()*Math.PI*2,
      vr: (Math.random()-0.5)*0.6,
      color: colors[Math.floor(Math.random()*colors.length)],
      born: now,
      life
    });
  }
  if (!rafId) { lastT = 0; rafId = requestAnimationFrame(loop); }
}

function loop(t){
  if (!lastT) lastT = t;
  const dt = (t - lastT)/1000;
  lastT = t;

  ctx.clearRect(0,0,W,H);

  const g = 0.0018 * H;
  const drag = 0.0008;

  for (let i = particles.length - 1; i >= 0; i--){
    const p = particles[i];
    if (t - p.born > p.life || p.y - p.size > H+40) { particles.splice(i,1); continue; }

    p.vy += g*dt;
    p.vx *= (1 - drag*H*dt);
    p.vy *= (1 - drag*H*dt*0.6);
    p.x  += p.vx*dt;
    p.y  += p.vy*dt;
    p.rot += p.vr;

    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.rotate(p.rot);
    ctx.fillStyle = p.color;
    if (i % 3 === 0) ctx.fillRect(-p.size/2, -p.size/2, p.size*0.9, p.size*0.4);
    else ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.65);
    ctx.restore();
  }

  if (particles.length) rafId = requestAnimationFrame(loop);
  else { rafId = null; ctx.clearRect(0,0,W,H); }
}
</script>
</body>
</html>
